# Load the shell dotfiles, and then some:
# * ~/.path can be used to extend `$PATH`.
for file in ~/.{path,exports,aliases,functions}; do
	[ -r "$file" ] && source "$file"
done
unset file

# Platform testing
platform='unknown'
unamestr=`uname`
if [[ "$unamestr" == 'Linux' ]]; then
	platform='linux'
elif [[ "$unamestr" == 'Darwin' ]]; then
	platform='macos'
fi

# rbenv
# Use rbenv to pick a Ruby version for your application and guarantee that
# your development environment matches production.
# https://github.com/rbenv/rbenv
if [ -d ~/.rbenv/bin ] ; then
	export PATH="$HOME/.rbenv/bin":$PATH
	eval "$(rbenv init -)"
fi

# dircolors
if [ -f ~/.dir_colors ] ; then
	eval `dircolors ~/.dir_colors`
fi

export TERM=xterm-256color

# Starship
# The minimal, blazing-fast, and infinitely customizable prompt for any shell!
# https://starship.rs/
eval "$(starship init zsh)"

# Volta
# The Hassle-Free JavaScript Tool Manager
# https://volta.sh/
export VOLTA_HOME="$HOME/.volta"
export PATH="$VOLTA_HOME/bin:$PATH"

# ctrl+w: delete a word
custom-backward-delete-word() {
    local WORDCHARS=${WORDCHARS/\//}
    zle backward-delete-word
}
zle -N custom-backward-delete-word
bindkey '^W' custom-backward-delete-word

# zplug
# https://github.com/zplug/zplug

### Workaround for https://github.com/zplug/zplug/issues/397
COMPINIT_ARGS=
if [ "${UID}" = 0 ] && [ -n "${SUDO_UID}" ] ; then
    if ! grep -q COMPINIT_ARGS ~/.zplug/base/core/load.zsh ; then
        sed -i -r 's/^(\s+)compinit -d/\1compinit $COMPINIT_ARGS -d/' ~/.zplug/base/core/load.zsh
    fi
    COMPINIT_ARGS="-u"
fi
export COMPINIT_ARGS
###

# Antibody
source ~/.zsh_plugins.sh

# Keybinding
# Additional keybindings
bindkey -e
bindkey '\ew' kill-region
bindkey -s '\el' "ls\n"
bindkey '^r' history-incremental-search-backward
bindkey "^[[5~" up-line-or-history
bindkey "^[[6~" down-line-or-history

# make search up and down work, so partially type and hit up/down to find relevant stuff
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

bindkey "^[[H" beginning-of-line
bindkey "^[[1~" beginning-of-line
bindkey "^[OH" beginning-of-line
bindkey "^[[F"  end-of-line
bindkey "^[[4~" end-of-line
bindkey "^[OF" end-of-line
bindkey ' ' magic-space    # also do history expansion on space

bindkey "^[[1;5C" forward-word
bindkey "^[[1;5D" backward-word

bindkey '^[[Z' reverse-menu-complete

# Make the delete key (or Fn + Delete on the Mac) work instead of outputting a ~
bindkey '^?' backward-delete-char
bindkey "^[[3~" delete-char
bindkey "^[3;5~" delete-char
bindkey "\e[3~" delete-char

# Completion
fpath=(~/dotfiles/zsh/completions $fpath)
fpath=(~/.zplug/repos/zsh-users/zsh-completions/src $fpath)
autoload -Uz compinit
compinit
